---
title: "Article (Data)"
author: "Alyssa Imbert and Etienne Thevenot (ProMetIS consortium)"
date: "`r doc_date()`"

vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: "ProMetIS.bib"
output:
  BiocStyle::html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: false
---

![](figures/prometis_logo.png)

```{r options, include=FALSE}
knitr::opts_chunk$set(fig.width = 8,
                      fig.height = 8,
                      fig.path = 'figures/article_data/',
                      message = FALSE,
                      warning = FALSE)
```

# Loading the LAT and MX2 data

```{r loading}
mset.ls <- lapply(ProMetIS::genes.vc(),
                  function(gene.c) {
                    gene.mset <- phenomis::reading(file.path(ProMetIS::aggregated_dir.c(gene.c)),
                                                   report.c = "none")
                    gene.mset <- gene.mset[, ProMetIS::sets.vc()]
                  })
names(mset.ls) <- ProMetIS::genes.vc()
```

# Number of samples and features for each dataset

```{r dims, fig.width = 10}
data_dims.mn <- NULL
for (gene.c in ProMetIS::genes.vc()) {
  gene.mset <- mset.ls[[gene.c]]
  gene_dims.mn <- t(sapply(names(gene.mset),
                          function(set.c) {
                            eset <- gene.mset[[set.c]]
                            rev(dim(eset))
                          }))
  colnames(gene_dims.mn) <- paste0(gene.c, "_", colnames(gene_dims.mn))
  data_dims.mn <- cbind(data_dims.mn, gene_dims.mn)
}

data_dims.mn <- data_dims.mn[c("clinics",
                               "proteomics_liver",
                               "metabolomics_liver_c18hyper_pos",
                               "metabolomics_liver_hilic_neg",
                               "proteomics_plasma",
                               "metabolomics_plasma_c18hyper_pos",
                               "metabolomics_plasma_hilic_neg",
                               "metabolomics_plasma_c18acqui_pos",
                               "metabolomics_plasma_c18acqui_neg"), ]

rownames(data_dims.mn) <- c("clinics",
                            "liver_proteomics",
                            "liver_metabo_c18hyper_pos",
                            "liver_metabo_hilic_neg",
                            "plasma_proteomics",
                            "plasma_metabo_c18hyper_pos",
                            "plasma_metabo_hilic_neg",
                            "plasma_metabo_c18acqui_pos",
                            "plasma_metabo_c18acqui_neg")

p <- phenomis::gg_barplot(data_dims.mn,
                          bar_just.n = 0,
                          cex_bar.i = 5,
                          cex_axis.i = 14,
                          palette.vc = c(LAT_Samples = as.character(ProMetIS::palette.vc(light.l = TRUE)["LAT"]),
                                         LAT_Features = as.character(ProMetIS::palette.vc()["LAT"]),
                                         MX2_Samples = as.character(ProMetIS::palette.vc(light.l = TRUE)["MX2"]),
                                         MX2_Features = as.character(ProMetIS::palette.vc()["MX2"])),
                          figure.c = "none")
p <- p + ggplot2::scale_y_continuous(trans = "log10", limits = c(1, NA),
                                     expand = ggplot2::expansion(add = c(0, 1)))
print(p)

grDevices::png("figures/article_data/sets_dims.png",
               width = 740)

print(p)

grDevices::dev.off()
```

# Preclinical features

```{r preclinical}
clinics.eset <- mset.ls[["LAT"]][["clinics"]]

p <- phenomis::gg_pie(Biobase::fData(clinics.eset), y.c = "category",
                 title.c = "Preclinical variables",
                 geom_text.ls = list(lab.i = 4, legend_text.i = 8, title.i = 18),
                 label.c = "value")

grDevices::png("figures/article_data/preclinical_categories.png")

print(p)

grDevices::dev.off()
```

# Technical validation

## Metabolomics

Loading the processed datasets:

```{r metabosets_loading}
metabo.mset <- phenomis::reading(file.path(ProMetIS::processed_dir.c()),
                                 subsets.vc = ProMetIS::metabo_sets.vc(),
                                 report.c = "none")
```
Post-processing the datasets (up to the log2 transformation) with either no signal drift correction, or a correction based on pools or on samples (the latter is the one used in the workflow; the other two are for comparison); pools are kept (for quality metrics computation and display):

```{r metabosets_postprocessing}
correct.vc <- c("none", "pool", "sample")

metabo_mset.ls <- vector(mode = "list", length = length(correct.vc))
names(metabo_mset.ls) <- correct.vc

for (correct.c in correct.vc) {
  print(correct.c)
  metabo_mset.ls[[correct.c]] <- ProMetIS:::metabo_postprocessing(metabo.mset = metabo.mset,
                                                                  drift_correct.c = correct.c,
                                                                  .discard_pools.l = FALSE)
}
# save(metabo_mset.ls, file = "metabo_mset_ls.rdata")
# load("../../ProMetISdev/vignettes/metabo_mset_ls.rdata")
```

```{r}
metabo_mset.ls <- lapply(metabo_mset.ls,
                         function(mset) phenomis::transforming(mset,
                                                               report.c = "none"))
```

For each drift correction, the following quality metrics are computed for each dataset:

* compounds: total number of features

* groups: number of groups of features putatively corresponding to the same metabolite (Monnerie et al., 2019; DOI:10.3390/metabo9110250)

* NA_0.2: % of features with less than 20% of missing values

* correl_inj_test: % of features significantly correlated with the injection order (Spearman correlation; Benjamini-Hochberg correction for multiple testing)

* correl_inj_pca: % of correlation between the 3 first PCA components and the injection order

* pool_spread_pca: % ratio between the maximum QC spread and the maximum sample spread in the 3 first PCA component space assessed by the Mahalanobis distance

* poolCV_0.3: % of features with CV of pools <= 30%

* ICCpool: intraclass correlation coefficient of pools at most probable abundance (Zhang et al., 2020; DOI:10.1021/acs.analchem.0c01493) 

```{r metabo_quality_metrics}
quality.mn <- ProMetIS:::quality(metabo.mset = metabo_mset.ls[["none"]])[["quality.mn"]]

quality.an <- array(0, dim = c(dim(quality.mn), length(correct.vc)),
                    dimnames = c(dimnames(quality.mn), list(correct.vc)))

quality.an[, , "none"] <- quality.mn

for (correct.c in correct.vc[-1])
  quality.an[, , correct.c] <- ProMetIS:::quality(metabo.mset = metabo_mset.ls[[correct.c]])[["quality.mn"]]
```

```{r}
for (metric.c in c("correl_inj_pca", "pool_spread_pca")) {
  quality.mn <- signif(quality.an[, metric.c, ], 2)
  # rownames(quality.mn) <- gsub("metabolomics_", "", rownames(quality.mn))
  p <- phenomis::gg_barplot(quality.mn,
                            cex_bar.i = 4,
                            bar_just.n = 0,
                            title.c = metric.c,
                            figure.c = "none")
  
  p <- p + ggplot2::scale_y_continuous(expand = ggplot2::expansion(add = c(0, ifelse(grepl("correl", metric.c), 5, 1))))
  print(p)
}
```


```{r}
signif(quality.an[, , "sample"], 2)
sapply(correct.vc,
       function(correct.c) {
         apply(quality.an[, c("correl_inj_pca", "pool_spread_pca"), correct.c],
               2,
               function(x) c(mean = mean(x), sd = sd(x), median = median(x), min = min(x), max = max(x)))
       })
for(correct.c in correct.vc)
   print(signif(apply(quality.an[, c("correl_inj_pca", "pool_spread_pca"), correct.c],
               2,
               function(x) c(mean = mean(x), sd = sd(x))), 2))
knitr::kable(signif(quality.an[, , "sample"], 2))
```

choisir les colonnes pca_corr_inj et pca_pool_spread
faire apparaitre les valeurs sur les scoreplots
montrer que c'est un compromis par rapport aux methodes none et pool (mean/median, min, max)
calculer les CV sur les pools, les samples (pour WT/LAT/MX2); idem en proteomique et en preclinique

For each drift correction, PCA score plot of each dataset

```{r metabo_quality_scoreplots}
for (correct.c in correct.vc) {
  metabo.mset <- metabo_mset.ls[[correct.c]]
  scoreplot.ls <- vector(mode = "list", length = length(ProMetIS::metabo_sets.vc()))
  names(scoreplot.ls) <- ProMetIS::metabo_sets.vc()
  
  for (set.c in ProMetIS::metabo_sets.vc()) {
    
    eset <- metabo.mset[[set.c]]
    pdata.df <- Biobase::pData(eset)
    pdata.df[, "order"] <- pdata.df[, "injectionOrder"]
    if (grepl("acqui", set.c))
      pdata.df[, "order"] <- pdata.df[, "order"] - min(pdata.df[, "order"]) + 1
    pdata.df[, "label"] <- ifelse(pdata.df[, "sampleType"] == "pool", "QC", "s")
    Biobase::pData(eset) <- pdata.df
    eset.pca <- ropls::opls(eset, predI = 2, fig.pdfC = "none", info.txtC = "none")
    scoreplot.ls[[set.c]] <- ProMetIS:::score_plotly(eset.pca,
                                                     label.c = "label",
                                                     color.c = "order",
                                                                                                          title.c = gsub("metabolomics_", "", set.c),
                                                     # title.c = paste0(gsub("metabolomics_", "", set.c), "\n(corr. inj.: ", round(quality.an[gsub("metabolomics_", "", set.c), "correl_inj_pca", "sample"]), "%)"),
                                                     figure.c = "interactive",
                                                     size.ls = list(axis_lab.i = 12,
                                                                    axis_text.i = 10,
                                                                    point.i = 2,
                                                                    label.i = 4,
                                                                    title.i = 15,
                                                                    legend_title.i = 10,
                                                                    legend_text.i = 10),
                                                     plot.l = FALSE)
    
  }
  
  scoreplots.p <- gridExtra::grid.arrange(grobs = scoreplot.ls[c("metabolomics_liver_c18hyper_pos",
                                                                 "metabolomics_plasma_c18hyper_pos",
                                                                 "metabolomics_plasma_c18acqui_pos",
                                                                 "metabolomics_liver_hilic_neg",
                                                                 "metabolomics_plasma_hilic_neg",
                                                                 "metabolomics_plasma_c18acqui_neg")],
                                          nrow = 2)
  ggplot2::ggsave(paste0("figures/article_data/metabo_qc_", correct.c, ".png"), scoreplots.p, width = 12)
}

```

```{r}
stat.mset <- phenomis::reading(ProMetIS::post_processed_dir.c())
stat.mset <- stat.mset[, ProMetIS::metabo_sets.vc()]
phenomis::inspecting(stat.mset)
```




