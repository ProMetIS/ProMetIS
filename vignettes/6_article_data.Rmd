---
title: "Article (Data)"
author: "Alyssa Imbert and Etienne Thevenot (ProMetIS consortium)"
date: "`r doc_date()`"

vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: "ProMetIS.bib"
output:
  BiocStyle::html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: false
---

![](figures/prometis_logo.png)

```{r options, include=FALSE}
knitr::opts_chunk$set(fig.width = 8,
                      fig.height = 8,
                      fig.path = 'figures/article_data/',
                      message = FALSE,
                      warning = FALSE)
```

# Loading the LAT and MX2 data

```{r loading}
mset.ls <- lapply(ProMetIS::genes.vc(),
                  function(gene.c) {
                    gene.mset <- phenomis::reading(file.path(ProMetIS::aggregated_dir.c(gene.c)),
                                                   report.c = "none")
                    gene.mset <- gene.mset[, ProMetIS::sets.vc()]
                  })
names(mset.ls) <- ProMetIS::genes.vc()
```

# Number of samples and features for each dataset

```{r dims, fig.width = 10}
data_dims.mn <- NULL
for (gene.c in ProMetIS::genes.vc()) {
  gene.mset <- mset.ls[[gene.c]]
  gene_dims.mn <- t(sapply(names(gene.mset),
                          function(set.c) {
                            eset <- gene.mset[[set.c]]
                            rev(dim(eset))
                          }))
  colnames(gene_dims.mn) <- paste0(gene.c, "_", colnames(gene_dims.mn))
  data_dims.mn <- cbind(data_dims.mn, gene_dims.mn)
}

data_dims.mn <- data_dims.mn[c("preclinical",
                               "proteomics_liver",
                               "metabolomics_liver_c18hyper_pos",
                               "metabolomics_liver_hilic_neg",
                               "proteomics_plasma",
                               "metabolomics_plasma_c18hyper_pos",
                               "metabolomics_plasma_hilic_neg",
                               "metabolomics_plasma_c18acqui_pos",
                               "metabolomics_plasma_c18acqui_neg"), ]

rownames(data_dims.mn) <- c("preclinical",
                            "liver_proteomics",
                            "liver_metabo_c18hyper_pos",
                            "liver_metabo_hilic_neg",
                            "plasma_proteomics",
                            "plasma_metabo_c18hyper_pos",
                            "plasma_metabo_hilic_neg",
                            "plasma_metabo_c18acqui_pos",
                            "plasma_metabo_c18acqui_neg")

p <- phenomis::gg_barplot(data_dims.mn,
                          bar_just.n = 0,
                          cex_bar.i = 5,
                          cex_axis.i = 14,
                          palette.vc = c(LAT_Samples = as.character(ProMetIS::palette.vc(light.l = TRUE)["LAT"]),
                                         LAT_Features = as.character(ProMetIS::palette.vc()["LAT"]),
                                         MX2_Samples = as.character(ProMetIS::palette.vc(light.l = TRUE)["MX2"]),
                                         MX2_Features = as.character(ProMetIS::palette.vc()["MX2"])),
                          figure.c = "none")
p <- p + ggplot2::scale_y_continuous(trans = "log10", limits = c(1, NA),
                                     expand = ggplot2::expansion(add = c(0, 1)))
print(p)

grDevices::png("figures/article_data/sets_dims.png",
               width = 740)

print(p)

grDevices::dev.off()
```

# Preclinical features

```{r preclinical}
preclinical.eset <- mset.ls[["LAT"]][["preclinical"]]

p <- phenomis::gg_pie(Biobase::fData(preclinical.eset), y.c = "category",
                 title.c = "Preclinical variables",
                 geom_text.ls = list(lab.i = 4, legend_text.i = 8, title.i = 18),
                 label.c = "value")

grDevices::png("figures/article_data/preclinical_categories.png")

print(p)

grDevices::dev.off()
```

# Technical validation

For each dataset, numerical and graphical quality controls are presented. 

## Preclinical (PHENOMIN ICS)

The objective is to check that the WT lines from the ProMetIS study have similar phenotyping values compared to all other WT lines generated by PHENOMIN ICS.

The ICS phenotyping database of WT lines is uploaded.

```{r}
wtdb_file.c <- "//10.0.238.33/Data/Phenostore/data/ProMetIS/cs1_phenomin/0_raw/technical_validation/preclinical/impc_5490_4sept2020.xlsx"

wtdb.tb <- suppressMessages(readxl::read_excel(wtdb_file.c,
                                               skip = 1))

wtdb.df <- as.data.frame(wtdb.tb,
                         stringsAsFactors = FALSE)

# excluding the first project (2 first rows) with NAs only

wtdb.df <- wtdb.df[-c(1, 2), ]

# naming rows

rownames(wtdb.df) <- paste0(wtdb.df[, "project"], "_", wtdb.df[, "mice"], "_", wtdb.df[, "sex"])
```

### Reference range

```{r}
message("Total nb of WT mice: ", nrow(wtdb.df))
message("Nb of females and males: ")
print(table(wtdb.df[, "sex"]))
```

```{r}
num.vl <- sapply(wtdb.df, data.class) == "numeric"

message("Number of numerical variables: ", sum(num.vl))

wtdb_num.df <- wtdb.df[, num.vl]
wtdb_num.ls <- split(wtdb_num.df, wtdb.df[, "sex"])

wtdb_range.ls <- lapply(wtdb_num.ls,
                        function(wtdb.mn) {
                          mean.vn <- apply(wtdb.mn, 2, function(x) mean(x, na.rm = TRUE))
                          sd.vn <- apply(wtdb.mn, 2, function(x) sd(x, na.rm = TRUE))
                          rbind(min = mean.vn - 2 * sd.vn,
                                max = mean.vn + 2 * sd.vn)
                        })

project.vi <- which(wtdb.df[, "project"] == "5490bp")
wtpm_mean.mn <- apply(wtdb_num.df[project.vi, ], 2,
                      function(y) tapply(y,
                                         wtdb.df[project.vi, "sex"],
                                         function(x) mean(x, na.rm = TRUE)))

wtdb_inrange.ls <- vector(mode = "list", length = length(wtdb_num.ls))
names(wtdb_inrange.ls) <- names(wtdb_num.ls)

for (sex.c in names(wtdb_inrange.ls)) {
  
  wtdb.mn <- wtdb_num.ls[[sex.c]]
  
  wtpm_inrange.vl <- logical(ncol(wtpm_mean.mn))
  names(wtpm_inrange.vl) <- colnames(wtpm_mean.mn)
  for (j in 1:ncol(wtpm_mean.mn))
    wtpm_inrange.vl[j] <- wtdb_range.ls[[sex.c]]["min", j] <= wtpm_mean.mn[sex.c, j] &
      wtpm_mean.mn[sex.c, j] <= wtdb_range.ls[[sex.c]]["max", j]
  
  wtdb_inrange.ls[[sex.c]] <- wtpm_inrange.vl
}

for (sex.c in names(wtdb_inrange.ls)) {
  
  message("Sex: ", ifelse(sex.c == "F", "females", "males"))
  wtpm_inrange.vl <- wtdb_inrange.ls[[sex.c]]
  
  wtpm_outlier.vi <- which(!wtpm_inrange.vl)
  message("Oulier variables: ")
  print(wtpm_outlier.vi)
  message("Non outlier variables in males: ",
          signif(sum(wtpm_inrange.vl, na.rm = TRUE) /
                   length(wtpm_inrange.vl[!is.na(wtpm_inrange.vl)]) * 100, 3),
          "%")
  
}
```


## Proteomics


```{r proteomics_files}
# liver
prot_liver_file.c <- "//10.0.238.33/Data/Phenostore/data/ProMetIS/cs1_phenomin/0_raw/technical_validation/proteomics_liver/DonnÃ©es pour figures Strasbourg QC.xlsx"

# plasma
prot_plasma_file.c <- "//10.0.238.33/Data/Phenostore/data/ProMetIS/cs1_phenomin/0_raw/technical_validation/proteomics_liver/figureQC_proteomique.xlsx"
```

### iRT

```{r proteomics_irt_loading}
# liver
irt_liver.tb <- suppressMessages(readxl::read_excel(prot_liver_file.c,
                                                     sheet = 1))

irt_liver.df <- as.data.frame(irt_liver.tb,
                               stringsAsFactors = FALSE)

irt_liver.mn <- as.matrix(irt_liver.df[-1, -1])
mode(irt_liver.mn) <- "numeric"
rownames(irt_liver.mn) <- irt_liver.df[, 1][-1]

pept_liver.vc <- rownames(irt_liver.mn)
rownames(irt_liver.mn) <- paste0("P", 1:nrow(irt_liver.mn))

# plasma

irt_plasma.tb <- suppressMessages(readxl::read_excel(prot_plasma_file.c,
                                                      sheet = 2))

irt_plasma.df <- as.data.frame(irt_plasma.tb,
                                stringsAsFactors = FALSE)

irt_plasma.mn <- as.matrix(irt_plasma.df[3:13, 21:65])
mode(irt_plasma.mn) <- "numeric"
rownames(irt_plasma.mn) <- irt_plasma.df[, 2][3:13]
pept_plasma.vc <- rownames(irt_plasma.mn)
stopifnot(identical(pept_liver.vc, pept_plasma.vc))
rownames(irt_plasma.mn) <- rownames(irt_liver.mn)
```

### CV

```{r prot_cv_load}
# liver
cv_liver.tb <- suppressMessages(readxl::read_excel(prot_liver_file.c,
                                                     sheet = 2,
                                                     range = "A1:E2469"))

cv_liver.df <- as.data.frame(cv_liver.tb,
                               stringsAsFactors = FALSE)

cv_liver.df <- cbind.data.frame(type = factor(rep(c("Pool", "WT", "Lat", "Mx2"),
                                                  each = nrow(cv_liver.df)),
                                              levels = c("Pool", "WT", "Lat", "Mx2")),
                                value = c(cv_liver.df[, 2], cv_liver.df[, 3],
                                          cv_liver.df[, 4], cv_liver.df[, 5]))

# plasma
cv_plasma.tb <- suppressMessages(readxl::read_excel(prot_plasma_file.c,
                                                      sheet = 4,
                                                      range = "A1:BT622"))

cv_plasma.df <- as.data.frame(cv_plasma.tb,
                                stringsAsFactors = FALSE)

cv_plasma.df <- cbind.data.frame(type = factor(rep(c("WT", "Mx2", "Lat", "Pool"),
                                                   each = nrow(cv_plasma.df)),
                                               levels = c("Pool", "WT", "Lat", "Mx2")),
                                 value = c(cv_plasma.df[, 69], cv_plasma.df[, 70],
                                           cv_plasma.df[, 71], cv_plasma.df[, 72]))
```

### Plotting

```{r}
irt_plot <- function(data.mn,
                     tissue.c = c("liver", "plasma")[1]) {
  
  data.df <- as.data.frame(t(data.mn))
  data.df[, "id"] <- 1:nrow(data.df)

  
  # reshaping in the long format
  plot_data.df <- reshape2::melt(data.df, id.var = "id")
  
  run.vc <- sapply(rownames(data.df),
                   function(x)
                     unlist(strsplit(unlist(strsplit(x, split = ".", fixed = TRUE))[1],
                                     split = "_"))[1],
                   USE.NAMES = FALSE)

  colnames(plot_data.df) <- gsub("variable", "peptides", colnames(plot_data.df))
  
  # plotting
  p <- ggplot2::ggplot(plot_data.df,
                       ggplot2::aes(x = id, y = value,
                                    group = peptides,
                                    colour = peptides)) +
    ggplot2::geom_point() +
    ggplot2::geom_line(ggplot2::aes(lty = peptides)) +
    ggplot2::scale_color_manual(values = RColorBrewer::brewer.pal(12, "Paired")[-11]) +
    # ggplot2::scale_color_brewer(palette = "Paired") +
    ggplot2::theme_light() +
    ggplot2::labs(title = tissue.c,
                  x = "LC-MS run",
                  y = "Retention time") +
    ggplot2::theme(axis.text = ggplot2::element_text(size = 11, face = "bold"),
                   axis.title = ggplot2::element_text(size = 11, face = "bold"),
                   axis.text.x = ggplot2::element_text(angle = 90,
                                                       size = 9,
                                                       hjust = 1,
                                                       vjust = 0.5),
                   legend.title = ggplot2::element_text(face = "bold"),
                   legend.text = ggplot2::element_text(face = "bold")) +
    ggplot2::scale_x_continuous(breaks = 1:length(run.vc),
                                labels = run.vc,
                                name = "LC-MS run")
                             
  return(invisible(p))
  
}


cv_plot <- function(data.tb,
                    tissue.c = c("liver", "plasma")) {
  
  color.c <- x.c <- "type"
  y.c <- "value"
  
  p <- ggplot2::ggplot(data.tb, ggplot2::aes(x = type, y = value, color = type)) +
    ggplot2::geom_boxplot(outlier.size = 1) +
    ggplot2::scale_colour_brewer(palette = "Set1") +
    ggplot2::labs(title = tissue.c, x = "", y = "CV (%)") +
    ggplot2::theme_light() +
    ggplot2::theme(plot.title = ggplot2::element_text(size = 11, face = "bold"),
                   axis.title.x = ggplot2::element_text(size = 11, face = "bold"),
                   axis.title.y = ggplot2::element_text(size = 11, face = "bold"),
                   axis.text = ggplot2::element_text(size = 11, face = "bold"),
                   legend.title = ggplot2::element_blank(),
                   legend.position = "none") +
    ggplot2::stat_boxplot(geom = "errorbar", width = 0.2)
  
  return(invisible(p))
  
}

irt_liver.gg <- irt_plot(irt_liver.mn)
irt_plasma.gg <- irt_plot(irt_plasma.mn, "plasma")
cv_liver.gg <- cv_plot(cv_liver.df)
cv_plasma.gg <- cv_plot(cv_plasma.df, "plasma")
```

```{r}
prot_qc_plot <- gridExtra::grid.arrange(irt_liver.gg,
                                        cv_liver.gg,
                                        irt_plasma.gg,
                                        cv_plasma.gg,
                                        nrow = 2, ncol = 2,
                                        widths = c(4, 2),
                                        heights = c(3, 3))
ggplot2::ggsave("figures/article_data/proteo_irt_cv.pdf", prot_qc_plot, width = 12, height = 7)
```

## Metabolomics

Loading the processed datasets:

```{r metabosets_loading}
metabo.mset <- phenomis::reading(file.path(ProMetIS::processed_dir.c()),
                                 subsets.vc = ProMetIS::metabo_sets.vc(),
                                 report.c = "none")
```

Post-processing the datasets with either no signal drift correction, or a correction based on pools or on samples (the latter is the one used in the workflow; the other two are for comparison); pools are kept (for quality metrics computation and display):

```{r metabosets_postprocessing}
correct.vc <- c("none", "pool", "sample")

metabo_mset.ls <- vector(mode = "list", length = length(correct.vc))
names(metabo_mset.ls) <- correct.vc

for (correct.c in correct.vc) {
  print(correct.c)
  metabo_mset.ls[[correct.c]] <- ProMetIS:::metabo_postprocessing(metabo.mset = metabo.mset,
                                                                  drift_correct.c = correct.c,
                                                                  .discard_pools.l = FALSE)
}
```

Log2 transformation:

```{r metabosets_logtransform}
metabo_mset.ls <- lapply(metabo_mset.ls,
                         function(mset) phenomis::transforming(mset,
                                                               report.c = "none"))
```

For each drift correction, the following quality metrics are computed for each dataset:

* compounds: total number of features

* correl_inj_pca: % of correlation between the 3 first PCA components and the injection order

* pool_spread_pca: % ratio between the maximum QC spread and the maximum sample spread in the 3 first PCA component space assessed by the Mahalanobis distance

```{r metabosets_quality_metrics}
quality.mn <- ProMetIS:::quality(metabo.mset = metabo_mset.ls[["none"]])

quality.an <- array(0, dim = c(dim(quality.mn), length(correct.vc)),
                    dimnames = c(dimnames(quality.mn), list(correct.vc)))

quality.an[, , "none"] <- quality.mn

for (correct.c in correct.vc[-1])
  quality.an[, , correct.c] <- ProMetIS:::quality(metabo.mset = metabo_mset.ls[[correct.c]])
```

```{r metabosets_quality_metrics_print}
for(correct.c in correct.vc) {
  print(correct.c)
  print(signif(apply(quality.an[, c("correl_inj_pca", "pool_spread_pca"), correct.c],
                     2,
                     function(x) c(mean = mean(x), sd = sd(x))), 2))
}
```

For each drift correction, PCA score plot of each dataset:

```{r metabosets_quality_scoreplots}
for (correct.c in correct.vc) {
  metabo.mset <- metabo_mset.ls[[correct.c]]
  scoreplot.ls <- vector(mode = "list", length = length(ProMetIS::metabo_sets.vc()))
  names(scoreplot.ls) <- ProMetIS::metabo_sets.vc()
  
  for (set.c in ProMetIS::metabo_sets.vc()) {
    
    eset <- metabo.mset[[set.c]]
    pdata.df <- Biobase::pData(eset)
    pdata.df[, "order"] <- pdata.df[, "injectionOrder"]
    if (grepl("acqui", set.c))
      pdata.df[, "order"] <- pdata.df[, "order"] - min(pdata.df[, "order"]) + 1
    pdata.df[, "label"] <- ifelse(pdata.df[, "sampleType"] == "pool", "QC", "s")
    Biobase::pData(eset) <- pdata.df
    eset.pca <- ropls::opls(eset, predI = 2, fig.pdfC = "none", info.txtC = "none")
    scoreplot.ls[[set.c]] <- ProMetIS:::score_plotly(eset.pca,
                                                     label.c = "label",
                                                     color.c = "order",
                                                                                                          title.c = gsub("metabolomics_", "", set.c),
                                                     # title.c = paste0(gsub("metabolomics_", "", set.c), "\n(corr. inj.: ", round(quality.an[gsub("metabolomics_", "", set.c), "correl_inj_pca", "sample"]), "%)"),
                                                     figure.c = "interactive",
                                                     size.ls = list(axis_lab.i = 12,
                                                                    axis_text.i = 10,
                                                                    point.i = 2,
                                                                    label.i = 4,
                                                                    title.i = 15,
                                                                    legend_title.i = 10,
                                                                    legend_text.i = 10),
                                                     plot.l = FALSE)
    
  }
  
  scoreplots.p <- gridExtra::grid.arrange(grobs = scoreplot.ls[c("metabolomics_liver_c18hyper_pos",
                                                                 "metabolomics_plasma_c18hyper_pos",
                                                                 "metabolomics_plasma_c18acqui_pos",
                                                                 "metabolomics_liver_hilic_neg",
                                                                 "metabolomics_plasma_hilic_neg",
                                                                 "metabolomics_plasma_c18acqui_neg")],
                                          nrow = 2)
  ggplot2::ggsave(paste0("figures/article_data/metabo_qc_", correct.c, ".pdf"), scoreplots.p, width = 12)
}

```





